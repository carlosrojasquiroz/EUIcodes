function [Z,agshock]=simulshocks(p,m)
%--------------------------------------------------------------------------------------------------------------------------    
% This function simulates the aggregate shock 'Z' using the transition
% probability matrix 'm.P'. I start the economy in the bad state. 
%--------------------------------------------------------------------------------------------------------------------------    
agshock=zeros(p.simulT,1);
agshock(1)=1; 
%--------------------------------------------------------------------------------------------------------------------------    
% prob_ag(i,j) is the probability of tomorrow's agg. shock (i=1,2) given 
% today's agg. shock (j=1,2)
%--------------------------------------------------------------------------------------------------------------------------    
prob_ag=zeros(2,2);  
prob_ag(1,1)=m.P(1,1)+m.P(1,2); prob_ag(2,1)=1-prob_ag(1,1);  
prob_ag(2,2)=m.P(3,3)+m.P(3,4); prob_ag(1,2)=1-prob_ag(2,2);
%--------------------------------------------------------------------------------------------------------------------------    
for t=2:p.simulT
   raux=rand; 
   if raux<=prob_ag(1,agshock(t-1)) 
      agshock(t)=1; 
   else
      agshock(t)=2;
   end
end
Z=m.Z_grid(agshock);
%--------------------------------------------------------------------------------------------------------------------------